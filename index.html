<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Jadwal Pimpinan</title>
  <link rel="icon" type="image/png" href="bps.png" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <img src="bps.png" alt="Logo BPS" class="logo" />
    <h1>ADMIN INPUT JADWAL PIMPINAN</h1>
  </header>

  <!-- üîê LOGIN FORM -->
  <section id="loginSection">
    <div class="login-card">
      <h2>Login Admin</h2>
      <form id="loginForm">
        <label>Email:</label>
        <input type="email" id="email" placeholder="Email admin" required />
        <label>Password:</label>
        <input type="password" id="password" placeholder="Password" required />
        <button type="submit">Login</button>
      </form>
    </div>
  </section>

  <!-- üßæ ADMIN SECTION -->
  <main id="adminSection" style="display: none;">
    <div class="top-bar">
      <button id="logoutBtn" class="logout">Logout</button>
    </div>

    <section class="form-section">
      <h2>Form Input Jadwal</h2>
      <form id="formKegiatan">
        <label>Hari/Tanggal:</label>
        <input type="date" id="tanggal" required />
        <label>Jam Acara:</label>
        <input type="time" id="jam" required />
        <label>Nama Kegiatan:</label>
        <input type="text" id="kegiatan" required placeholder="Masukkan nama kegiatan" />
        <label>Alamat/Tempat:</label>
        <input type="text" id="tempat" required placeholder="Masukkan tempat kegiatan" />
        <label>Tim:</label>
        <input type="text" id="tim" required placeholder="Nama Tim atau Personil" />
        <label>Keterangan:</label>
        <textarea id="keterangan" placeholder="Tambahkan keterangan..."></textarea>
        <label>Konfirmasi Kehadiran:</label>
        <select id="kehadiran" required>
          <option value="">-- Pilih Konfirmasi --</option>          
          <option value="-">-</option>
          <option value="Tunggu Konfirmasi">Tunggu Konfirmasi</option>
          <option value="Dihadiri Kepala">Dihadiri Kepala</option>
          <option value="Diwakilkan">Diwakilkan</option>          
        </select>
        <label>Pilih Warna Penanda:</label>
        <select id="warna">
          <option value="biru">Biru</option>
          <option value="merah">Merah</option>
          <option value="kuning">Kuning</option>
          <option value="hijau">Hijau</option>          
        </select>
        <button type="submit">Simpan Jadwal</button>
      </form>
    </section>

    <section class="table-section">
      <h2>Daftar Jadwal yang Sudah Diinput</h2>
      <p id="infoBulan" style="font-weight: bold; color: #007bff; margin-top: -5px;"></p>
      <button id="toggleBulanBtn">üîÅ Tampilkan Semua Bulan</button>

      <input type="text" id="searchInput" placeholder="üîç Cari jadwal (nama, tempat, tim, tanggal...)" />

      <table id="tabelKegiatan">
        <thead>
          <tr>
            <th>Hari/Tanggal</th>
            <th>Jam</th>
            <th>Kegiatan</th>
            <th>Tempat</th>
            <th>Tim</th>
            <th>Keterangan</th>
            <th>Kehadiran</th>
            <th>Warna</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="daftarKegiatan"></tbody>
      </table>
    </section>
  </main>

  <footer>
    <p>¬© 2025 BPS Provinsi Sumatera Barat</p>
  </footer>

  <!-- üî• FIREBASE SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB0Flu6NacmEFNBr3_8gaqfmmzUi8gJ8Es",
      authDomain: "jadwal-pimpinan-8b0ef.firebaseapp.com",
      projectId: "jadwal-pimpinan-8b0ef",
      storageBucket: "jadwal-pimpinan-8b0ef.appspot.com",
      messagingSenderId: "360212048977",
      appId: "1:360212048977:web:1ff5749cd1416ad08f5c70",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const colRef = collection(db, "jadwal");

    const loginSection = document.getElementById("loginSection");
    const adminSection = document.getElementById("adminSection");
    const loginForm = document.getElementById("loginForm");
    const logoutBtn = document.getElementById("logoutBtn");
    const formKegiatan = document.getElementById("formKegiatan");
    const simpanBtn = formKegiatan.querySelector("button[type='submit']");
    const searchInput = document.getElementById("searchInput");
    const toggleBulanBtn = document.getElementById("toggleBulanBtn");
    const infoBulan = document.getElementById("infoBulan");
    let semuaData = [];
    let editId = null;
    let tampilSemua = false;

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      try {
        await signInWithEmailAndPassword(auth, email.value, password.value);
        alert("‚úÖ Login berhasil!");
      } catch {
        alert("‚ùå Login gagal! Periksa email & password.");
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      formKegiatan.reset();
      simpanBtn.textContent = "Simpan Jadwal";
      editId = null;
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginSection.style.display = "none";
        adminSection.style.display = "block";
        tampilkanKegiatan();
      } else {
        loginSection.style.display = "block";
        adminSection.style.display = "none";
      }
    });

    formKegiatan.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        tanggal: tanggal.value,
        jam: jam.value,
        kegiatan: kegiatan.value,
        tempat: tempat.value,
        tim: tim.value,
        keterangan: keterangan.value,
        kehadiran: kehadiran.value,
        warna: warna.value
      };
      if (editId) {
        await updateDoc(doc(db, "jadwal", editId), data);
        alert("‚úÖ Jadwal diperbarui!");
        editId = null;
        simpanBtn.textContent = "Simpan Jadwal";
      } else {
        await addDoc(colRef, data);
        alert("‚úÖ Jadwal disimpan!");
      }
      formKegiatan.reset();
      tampilkanKegiatan();
    });

    async function tampilkanKegiatan() {
      const daftarKegiatan = document.getElementById("daftarKegiatan");
      daftarKegiatan.innerHTML = "";
      const snapshot = await getDocs(colRef);

      semuaData = snapshot.docs.map((d) => ({ id: d.id, ...d.data() }));
      const now = new Date();
      const bulan = now.getMonth() + 1;
      const tahun = now.getFullYear();
      const namaBulan = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
      const dataTampil = tampilSemua
        ? semuaData
        : semuaData.filter((i) => {
            const tgl = new Date(i.tanggal);
            return tgl.getMonth() + 1 === bulan && tgl.getFullYear() === tahun;
          });

      infoBulan.textContent = tampilSemua
        ? "üìÖ Menampilkan Semua Jadwal"
        : `üóìÔ∏è Jadwal Bulan ${namaBulan[bulan - 1]} ${tahun}`;
      toggleBulanBtn.textContent = tampilSemua ? "‚¨ÖÔ∏è Tampilkan Bulan Ini" : "üîÅ Tampilkan Semua Bulan";

      dataTampil.sort((a, b) => new Date(b.tanggal + "T" + b.jam) - new Date(a.tanggal + "T" + a.jam));
      renderTabel(dataTampil);
    }

    toggleBulanBtn.addEventListener("click", () => {
      tampilSemua = !tampilSemua;
      tampilkanKegiatan();
    });

    function renderTabel(dataArray) {
      const daftarKegiatan = document.getElementById("daftarKegiatan");
      daftarKegiatan.innerHTML = dataArray.length
        ? dataArray.map((d) => `
          <tr>
            <td>${d.tanggal}</td>
            <td>${d.jam}</td>
            <td>${d.kegiatan}</td>
            <td>${d.tempat}</td>
            <td>${d.tim}</td>
            <td>${d.keterangan || "-"}</td>
            <td>${d.kehadiran || "-"}</td>
            <td><span class="warna-box ${d.warna}">${d.warna}</span></td>
            <td>
              <button class="editBtn" data-id="${d.id}">Edit</button>
              <button class="deleteBtn" data-id="${d.id}">Hapus</button>
            </td>
          </tr>`).join("")
        : `<tr><td colspan="9">Tidak ada data ditemukan</td></tr>`;

      document.querySelectorAll(".deleteBtn").forEach((btn) => {
        btn.onclick = async () => {
          if (confirm("Yakin hapus jadwal ini?")) {
            await deleteDoc(doc(db, "jadwal", btn.dataset.id));
            tampilkanKegiatan();
          }
        };
      });

      document.querySelectorAll(".editBtn").forEach((btn) => {
        btn.onclick = () => {
          const d = semuaData.find((x) => x.id === btn.dataset.id);
          Object.entries(d).forEach(([k, v]) => {
            if (document.getElementById(k)) document.getElementById(k).value = v;
          });
          editId = d.id;
          simpanBtn.textContent = "Update Jadwal";
          window.scrollTo({ top: 0, behavior: "smooth" });
        };
      });
    }

    searchInput.addEventListener("input", (e) => {
      const k = e.target.value.toLowerCase();
      const hasil = semuaData.filter((i) =>
        [i.kegiatan, i.tempat, i.tim, i.tanggal].some((f) => f?.toLowerCase().includes(k))
      );
      renderTabel(hasil);
    });
  </script>
</body>
</html>
