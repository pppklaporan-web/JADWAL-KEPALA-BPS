<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Jadwal Pimpinan</title>
  <link rel="icon" type="image/png" href="bps.png" />
  <link rel="stylesheet" href="style.css" />
  <style>
    #searchInput {
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <header>
    <img src="bps.png" alt="Logo BPS" class="logo" />
    <h1>ADMIN INPUT JADWAL PIMPINAN</h1>
  </header>

  <!-- üîê LOGIN FORM -->
  <section id="loginSection">
    <div class="login-card">
      <h2>Login Admin</h2>
      <form id="loginForm">
        <label>Email:</label>
        <input type="email" id="email" placeholder="Email admin" required />
        <label>Password:</label>
        <input type="password" id="password" placeholder="Password" required />
        <button type="submit">Login</button>
      </form>
    </div>
  </section>

  <!-- üßæ ADMIN SECTION -->
  <main id="adminSection" style="display: none;">
    <div class="top-bar">
      <button id="logoutBtn" class="logout">Logout</button>
    </div>

    <!-- üìù FORM INPUT -->
    <section class="form-section">
      <h2>Form Input Jadwal</h2>
      <form id="formKegiatan">
        <label>Hari/Tanggal:</label>
        <input type="date" id="tanggal" required />

        <label>Jam Acara:</label>
        <input type="time" id="jam" required />

        <label>Nama Kegiatan:</label>
        <input type="text" id="kegiatan" required placeholder="Masukkan nama kegiatan" />

        <label>Alamat/Tempat:</label>
        <input type="text" id="tempat" required placeholder="Masukkan tempat kegiatan" />

        <label>Tim:</label>
        <input type="text" id="tim" required placeholder="Nama Tim atau Personil" />

        <label>Keterangan:</label>
        <textarea id="keterangan" placeholder="Tambahkan keterangan..."></textarea>

        <label>Konfirmasi Kehadiran:</label>
        <select id="kehadiran" required>
          <option value="">-- Pilih Konfirmasi --</option>          
          <option value="-">-</option>
          <option value="Tunggu Konfirmasi">Tunggu Konfirmasi</option>
          <option value="Dihadiri Kepala">Dihadiri Kepala</option>
          <option value="Diwakilkan">Diwakilkan</option>          
        </select>

        <label>Pilih Warna Penanda:</label>
        <select id="warna">
          <option value="biru">Biru</option>
          <option value="merah">Merah</option>
          <option value="kuning">Kuning</option>
          <option value="hijau">Hijau</option>          
        </select>

        <button type="submit">Simpan Jadwal</button>
      </form>
    </section>

    <!-- üìã DAFTAR JADWAL -->
    <section class="table-section">
      <h2>Daftar Jadwal yang Sudah Diinput</h2>
      <p id="infoBulan" style="font-weight: bold; color: #007bff; margin-top: -5px;"></p>

      <button id="toggleBulanBtn" 
        style="margin-bottom:10px; padding:5px 10px; border-radius:6px; border:1px solid #ccc; background:#f0f0f0; cursor:pointer;">
        üîÅ Tampilkan Semua Bulan
      </button>

      <input type="text" id="searchInput" placeholder="Cari jadwal..." />

      <table border="1" cellspacing="0" cellpadding="6" width="100%">
        <thead style="background:#f8f8f8;">
          <tr>
            <th>Hari/Tanggal</th>
            <th>Jam</th>
            <th>Kegiatan</th>
            <th>Tempat</th>
            <th>Tim</th>
            <th>Keterangan</th>
            <th>Kehadiran</th>
            <th>Warna</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="daftarKegiatan"></tbody>
      </table>
    </section>
  </main>

  <footer>
    <p>¬© 2025 BPS Provinsi Sumatera Barat</p>
  </footer>

  <!-- üî• FIREBASE SETUP -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // üîß Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyB0Flu6NacmEFNBr3_8gaqfmmzUi8gJ8Es",
      authDomain: "jadwal-pimpinan-8b0ef.firebaseapp.com",
      projectId: "jadwal-pimpinan-8b0ef",
      storageBucket: "jadwal-pimpinan-8b0ef.appspot.com",
      messagingSenderId: "360212048977",
      appId: "1:360212048977:web:1ff5749cd1416ad08f5c70",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const colRef = collection(db, "jadwal");

    const loginSection = document.getElementById("loginSection");
    const adminSection = document.getElementById("adminSection");
    const loginForm = document.getElementById("loginForm");
    const logoutBtn = document.getElementById("logoutBtn");
    const formKegiatan = document.getElementById("formKegiatan");
    const simpanBtn = formKegiatan.querySelector("button[type='submit']");
    const searchInput = document.getElementById("searchInput");
    let semuaData = [];
    let editId = null;
    let tampilSemua = false;

    // üîê Login
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
        alert("‚úÖ Login berhasil!");
      } catch (error) {
        alert("‚ùå Login gagal! Periksa email & password.");
      }
    });

    // üö™ Logout
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      formKegiatan.reset();
      simpanBtn.textContent = "Simpan Jadwal";
      editId = null;
    });

    // üëÄ Pantau login
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginSection.style.display = "none";
        adminSection.style.display = "block";
        tampilkanKegiatan();
      } else {
        loginSection.style.display = "block";
        adminSection.style.display = "none";
      }
    });

    // üßæ Simpan / Update
    formKegiatan.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        tanggal: document.getElementById("tanggal").value,
        jam: document.getElementById("jam").value,
        kegiatan: document.getElementById("kegiatan").value,
        tempat: document.getElementById("tempat").value,
        tim: document.getElementById("tim").value,
        keterangan: document.getElementById("keterangan").value,
        kehadiran: document.getElementById("kehadiran").value,
        warna: document.getElementById("warna").value,
      };

      if (editId) {
        await updateDoc(doc(db, "jadwal", editId), data);
        alert("‚úÖ Jadwal berhasil diperbarui!");
        editId = null;
        simpanBtn.textContent = "Simpan Jadwal";
      } else {
        await addDoc(colRef, data);
        alert("‚úÖ Jadwal berhasil disimpan!");
      }
      formKegiatan.reset();
      tampilkanKegiatan(tampilSemua);
    });

    // üìã Tampilkan Jadwal (bulan ini / semua)
    async function tampilkanKegiatan(tampilkanSemua = false) {
      const daftarKegiatan = document.getElementById("daftarKegiatan");
      daftarKegiatan.innerHTML = "";
      const snapshot = await getDocs(colRef);
      semuaData = snapshot.docs.map(docItem => ({ id: docItem.id, ...docItem.data() }));

      const sekarang = new Date();
      const bulanIni = sekarang.getMonth() + 1;
      const tahunIni = sekarang.getFullYear();
      const namaBulan = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];

      let dataTampil = semuaData;
      if (!tampilkanSemua) {
        dataTampil = semuaData.filter(item => {
          const tgl = new Date(item.tanggal);
          return tgl.getMonth() + 1 === bulanIni && tgl.getFullYear() === tahunIni;
        });
      }

      document.getElementById("infoBulan").textContent =
        tampilkanSemua
          ? "üìÖ Menampilkan Semua Jadwal"
          : `üóìÔ∏è Menampilkan Jadwal Bulan: ${namaBulan[bulanIni - 1]} ${tahunIni}`;

      document.getElementById("toggleBulanBtn").textContent =
        tampilkanSemua ? "‚¨ÖÔ∏è Tampilkan Bulan Ini" : "üîÅ Tampilkan Semua Bulan";

      dataTampil.sort((a, b) => new Date(b.tanggal + "T" + (b.jam || "00:00")) - new Date(a.tanggal + "T" + (a.jam || "00:00")));

      renderTabel(dataTampil);
    }

    // üîÅ Tombol Ganti Mode Bulan
    const toggleBtn = document.getElementById("toggleBulanBtn");
    toggleBtn.addEventListener("click", () => {
      tampilSemua = !tampilSemua;
      tampilkanKegiatan(tampilSemua);
    });

    // üîç Render Tabel
    function renderTabel(dataArray) {
      const daftarKegiatan = document.getElementById("daftarKegiatan");
      daftarKegiatan.innerHTML = "";
      dataArray.forEach(data => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${data.tanggal}</td>
          <td>${data.jam}</td>
          <td>${data.kegiatan}</td>
          <td>${data.tempat}</td>
          <td>${data.tim}</td>
          <td>${data.keterangan}</td>
          <td>${data.kehadiran || "-"}</td>
          <td><span class="warna-box ${data.warna}">${data.warna}</span></td>
          <td>
            <button class="editBtn" data-id="${data.id}">Edit</button>
            <button class="deleteBtn" data-id="${data.id}">Hapus</button>
          </td>
        `;
        daftarKegiatan.appendChild(row);
      });

      document.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          if (confirm("Yakin hapus jadwal ini?")) {
            await deleteDoc(doc(db, "jadwal", btn.dataset.id));
            tampilkanKegiatan(tampilSemua);
          }
        });
      });

      document.querySelectorAll(".editBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const item = semuaData.find(d => d.id === btn.dataset.id);
          if (item) {
            document.getElementById("tanggal").value = item.tanggal;
            document.getElementById("jam").value = item.jam;
            document.getElementById("kegiatan").value = item.kegiatan;
            document.getElementById("tempat").value = item.tempat;
            document.getElementById("tim").value = item.tim;
            document.getElementById("keterangan").value = item.keterangan;
            document.getElementById("kehadiran").value = item.kehadiran || "";
            document.getElementById("warna").value = item.warna || "biru";
            editId = item.id;
            simpanBtn.textContent = "Update Jadwal";
            window.scrollTo({ top: 0, behavior: "smooth" });
          }
        });
      });
    }

    // üîé Pencarian Real-Time
    searchInput.addEventListener("input", (e) => {
      const keyword = e.target.value.toLowerCase();
      const hasil = semuaData.filter(item =>
        (item.kegiatan?.toLowerCase().includes(keyword)) ||
        (item.tempat?.toLowerCase().includes(keyword)) ||
        (item.tim?.toLowerCase().includes(keyword)) ||
        (item.tanggal?.toLowerCase().includes(keyword))
      );
      renderTabel(hasil);
    });
  </script>
</body>
</html>
